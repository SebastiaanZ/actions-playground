on:
  pull_request_review:


jobs:
  core-dev-check:
    name: At least one core developer needs to accept the PR
    runs-on: ubuntu-latest

    steps:
      - run: cat $GITHUB_EVENT_PATH

      - uses: octokit/graphql-action@v2.x
        id: reviews
        with:
          query: |
            query ($repository: String!, $pr: Int!) {
              repository(owner: "python-discord", name: $repository) {
                pullRequest(number: $pr) {
                  latestOpinionatedReviews(last: 100, writersOnly: true) {
                    nodes{
                      author{
                        login
                      }
                      state
                    }
                  }
                }
              }
            }
          repository: 'bot'
          pr: 1269
#          owner: ${{ github.event.repository.owner.login }}
#          repository: ${{ github.event.repository.name }}
#          pr: ${{ github.event.pull_request.number }}
        env:
          GITHUB_TOKEN: ${{ secrets.DISPATCH_TOKEN }}

      - uses: octokit/graphql-action@v2.x
        id: core_developers
        with:
          query: |
            query {
              organization(login: "python-discord") {
                team(slug: "core-developers") {
                  members(first: 100) {
                    nodes {
                      login
                    }
                  }
                }
              }
            }
        env:
          GITHUB_TOKEN: ${{ secrets.DISPATCH_TOKEN }}

      - name: Setup python
        id: python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - run: |
          python -c 'import json
          reviewers = json.loads("${{ steps.reviewers.outputs.data }}")
          core_devs = json.loads("${{ steps.core_developers.outputs.data }}")
          print(reviewers)
          print(core_devs)'
